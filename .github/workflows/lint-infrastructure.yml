name: Infrastructure Lint and Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**/*.tf'
      - '**/*.tf.json'
      - '**/*.sh'
      - '**/*.groovy'
      - '**/Jenkinsfile'
      - '**/user-data.sh'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**/*.tf'
      - '**/*.tf.json'
      - '**/*.sh'
      - '**/*.groovy'
      - '**/Jenkinsfile'
      - '**/user-data.sh'

jobs:
  lint-infrastructure:
    name: Infrastructure Lint and Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Install ShellCheck
        run: |
          echo "ğŸ” Installing ShellCheck..."
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run Infrastructure Linting
        run: |
          echo "ğŸ” Running comprehensive infrastructure linting..."
          chmod +x scripts/pre-commit-lint.sh
          ./scripts/pre-commit-lint.sh

  summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs: [lint-infrastructure]
    if: always()
    steps:
      - name: Lint Results Summary
        run: |
          echo "ğŸ“Š Lint Results Summary:"
          echo "  - Infrastructure Lint: ${{ needs.lint-infrastructure.result }}"
          
          if [[ "${{ needs.lint-infrastructure.result }}" == "success" ]]; then
            echo "ğŸ‰ All lint checks passed!"
          else
            echo "âŒ Some lint checks failed. Please review the errors above."
            exit 1
          fi